{% extends 'index.html' %}
{% block body %}
<figure class="text-center" style="color: rgb(105, 5, 42);">
    <blockquote class="blockquote fs-1 me-5 pe-5 my-4">
      <p>HeartTalk</p>
    </blockquote>
    <figcaption class="blockquote-footer ms-5 ps-5">
        Just say whatever in your mind 
    </figcaption>
</figure>
    <div class="container mt-4">
        <div class="row">
            <div class="col-2"></div>
          <div class="col-3">
            <h3 class="text-center m-2 p-2">Members</h3>
            <ul id="members-list" class="list-group"></ul>
          </div>
          <div class="col-3"></div>
          <div class="col-3">
            <div class="d-flex">
                <div class="text-center m-2 p-2 fs-3 fw-bold ">Groups</div>
                <div><a href="/creategroup/" class="btn btn-outline-secondary btn-sm m-3 mt-4">New</a></div>
            </div>
            <ul id="groups-list" class="list-group"></ul>
          </div>
          <div class="col-1"></div>
        </div>
    </div>
    <script>
        
        document.addEventListener('DOMContentLoaded', function () {
            function getCookie(name) {
                let cookieArr = document.cookie.split(";");

                // Iterate over all cookies
                for (let i = 0; i < cookieArr.length; i++) {
                    let cookie = cookieArr[i].trim();

                    // Check if the cookie starts with the given name followed by an '=' sign
                    if (cookie.startsWith(name + "=")) {
                        return cookie.substring(name.length + 1);
                    }
                }
                return null;  // Return null if the cookie is not found
            }
            function getCSRFToken() {
                let cookies = document.cookie.split('; ');
                for (let i = 0; i < cookies.length; i++) {
                    let [key, value] = cookies[i].split('=');
                    if (key === 'csrftoken') {
                        return value;
                    }
                }
                return '';
            }
            const token = getCookie('token');
            console.log(window.location.host);
            url = window.location.host === '127.0.0.1:8000' ? 'http://localhost:8000/api/home/' : 'https://'+window.location.host+'/api/home/';
            fetch('http://localhost:8000/api/home/', {
                    method: 'GET',
                    headers:{
                        'Content-Type': 'application/json',
                        'Authorization': `Token ${token}`
                    }

                })
                .then(response => response.json())
                .then(data => {
                    const membersList = document.getElementById('members-list');
                    const groupsList = document.getElementById('groups-list');
                    data.members.forEach(member => {
                        let li = document.createElement('li');
                        li.textContent = member.username;
                        li.classList.add('list-group-item','d-flex','fs-4');

                        // Create form for each member
                        let form = document.createElement('form');
                        form.method = 'POST';
                        form.action = '/room/';

                        let csrfInput = document.createElement('input');
                        csrfInput.type = 'hidden';
                        csrfInput.name = 'csrfmiddlewaretoken';
                        csrfInput.value = getCSRFToken();

                        let input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'chat_name';
                        input.value = member.username;

                        let button = document.createElement('button');
                        button.type = 'submit';
                        button.textContent = 'Chat';
                        button.classList.add('btn', 'btn-secondary', 'ms-5','chat-button');

                        form.appendChild(csrfInput);
                        form.appendChild(input);
                        form.appendChild(button);
                        li.appendChild(form);
                        membersList.appendChild(li);
                    });
                    data.groups.forEach(group => {
                        let li = document.createElement('li');
                        li.textContent = group.name;
                        li.classList.add('list-group-item','d-flex','fs-4');

                        // Create form for each group
                        let form = document.createElement('form');
                        form.method = 'POST';
                        form.action = '/room/';

                        let csrfInput = document.createElement('input');
                        csrfInput.type = 'hidden';
                        csrfInput.name = 'csrfmiddlewaretoken';
                        csrfInput.value = getCSRFToken();

                        let input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'chat_name';
                        input.value = group.name;

                        let button = document.createElement('button');
                        button.type = 'submit';
                        button.textContent = 'Chat';
                        button.classList.add('btn', 'btn-primary', 'ms-5','chat-button');

                        form.appendChild(csrfInput);
                        form.appendChild(input);
                        form.appendChild(button);
                        li.appendChild(form);
                        groupsList.appendChild(li);
                    });
                })
                .catch(error => console.error('Error fetching data:', error));
        });
    </script>
{% endblock %}
    
